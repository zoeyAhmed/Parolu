{
    "id": "im.bernard.Parolu",
    "runtime": "org.gnome.Platform",
    "runtime-version": "48",
    "sdk": "org.gnome.Sdk",
    "command": "parolu",
    "finish-args": [
        "--share=network",
        "--share=ipc",
        "--socket=fallback-x11",
        "--device=dri",
        "--socket=wayland",
        "--socket=pulseaudio"
    ],
    "cleanup": [
        "/include",
        "/lib/pkgconfig",
        "/man",
        "/share/doc",
        "/share/gtk-doc",
        "/share/man",
        "/share/pkgconfig",
        "*.la",
        "*.a"
    ],
    "build-options" : {
        "env" : {
            "ONNX_ROOT" : "/app/onnx_root"
        }
    },
    "modules": [
        "python3-requirements.json",
        "python3-numpy.json",
        {
            "name": "espeak",
            "buildsystem": "autotools",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/rhasspy/espeak-ng/archive/8593723f10cfd9befd50de447f14bf0a9d2a14a4.zip",
                    "sha256": "cc8092f23a28ccd79b1c5e62984a4c4ac1959d2d0b8193ac208d728c620bd5ed"
                }
            ]
        },
        {
            "name" : "onnxruntime",
            "buildsystem" : "simple",
            "sources" : [
                {
                    "type" : "archive",
                    "only-arches" : ["x86_64"],
                    "dest" : "onnxruntime-1",
                    "url" : "https://github.com/microsoft/onnxruntime/releases/download/v1.16.1/onnxruntime-linux-x64-1.16.1.tgz",
                    "sha256" : "53a0f03f71587ed602e99e82773132fc634b74c2d227316fbfd4bf67181e72ed",
                    "strip-components": 1
                },

                {
                    "type" : "archive",
                    "only-arches" : ["aarch64"],
                    "dest" : "onnxruntime-1",
                    "url" : "https://github.com/microsoft/onnxruntime/releases/download/v1.16.1/onnxruntime-linux-aarch64-1.16.1.tgz",
                    "sha256" : "f10851b62eb44f9e811134737e7c6edd15733d2c1549cb6ce403808e9c047385",
                    "strip-components": 1
                }
            ],
            "build-commands" : [
                "mkdir -p $ONNX_ROOT",
                "mv onnxruntime-1/* $ONNX_ROOT",

                "cp $ONNX_ROOT/lib/* $FLATPAK_DEST/lib",
                "cp -v $ONNX_ROOT/include/*.h $FLATPAK_DEST/include/"
            ]
        },
        {
            "name": "piperphonemize",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_POSITION_INDEPENDENT_CODE=ON",
                "-DBUILD_SHARED_LIBS=ON"
            ],
            "build-commands": [
                "cmake --install . --prefix=/app",
                "ln -sf /app/lib/libpiper_phonemize.so.1 /app/lib/libpiper_phonemize.so"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/rhasspy/piper-phonemize/archive/7f7b5bd4de22f7fe24341c5bedda0dc1e33f3666.zip",
                    "sha256": "6bdcb21f6c5ae0deff7c9ae26bf07b994791dc800c1962fd216727e66a409929"
                },
                {
                    "type": "patch",
                    "path": "./patches/piperphonemize.patch"
                }
            ]
        },
        {
            "name": "spdlog",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/gabime/spdlog/archive/refs/tags/v1.11.0.tar.gz",
                    "sha256": "ca5cae8d6cac15dae0ec63b21d6ad3530070650f68076f3a4a862ca293a858bb"
                }
            ]
        },
        {
            "name": "pybind11",
            "buildsystem": "cmake",
            "config-opts": [
                "-DPYBIND11_TEST=OFF"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/pybind/pybind11.git",
                    "tag": "v2.13.5"
                }
            ]
        },
        {
            "name": "piper",
            "buildsystem": "cmake-ninja",
            "build-options": {
                "env": {
                    "PKG_CONFIG_PATH": "/app/lib/pkgconfig",
                    "CMAKE_PREFIX_PATH": "/app",
                    "LD_LIBRARY_PATH": "/app/lib",
                    "CPLUS_INCLUDE_PATH": "/app/include/piper-phonemize:/app/include",
                    "C_INCLUDE_PATH": "/app/include/piper-phonemize:/app/include"
                }
            },
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_POSITION_INDEPENDENT_CODE=ON",
                "-DPIPER_PHONEMIZE_INCLUDE=/app/include/piper-phonemize",
                "-Donnxruntime_LIBRARY=/app/lib/libonnxruntime.so.1.16.1",
                "-Donnxruntime_INCLUDE_DIR=/app/include/onnxruntime"
            ],
            "build-commands": [
                "mkdir -p /app/include/python3.12",
                "cp -r /usr/include/python3.12/* /app/include/python3.12/",
                "mkdir -p /app/include/piper",
                "cp src/cpp/piper.hpp /app/include/piper/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/rhasspy/piper/archive/e268564deb779af984ac8f632c98727447632124.zip",
                    "sha256": "213a31c23c862cbcd9de4231c07d32de35f4ee0b5b5dec52e9ae6dd3aa70ac12",
                    "strip-components": 1
                },
                {
                    "type": "file",
                    "path": "patches/piper_api.cpp",
                    "dest-filename": "piper_api.cpp"
                },
                {
                    "type": "file",
                    "path": "patches/piper_api.h",
                    "dest-filename": "piper_api.h"
                },
                {
                    "type": "file",
                    "path": "patches/CMakeLists.txt",
                    "dest-filename": "CMakeLists.txt"
                }
            ]
        },
        {
            "name": "piper-python",
            "buildsystem": "simple",
            "build-options": {
                "cxxflags": "-o3 -Wall -shared -std=c++17 -fPIC"
            },
            "build-commands": [
                "mkdir -p /app/lib/python3.12/site-packages",
                "g++ $CXXFLAGS -I/app/include -I/app/include/python3.12 -I/app/include/piper-phonemize piper.cpp -o /app/lib/python3.12/site-packages/piper.so -L/app/lib -lpiper_api -lpiper_phonemize -lespeak-ng -lonnxruntime -Wl,-rpath=/app/lib"
            ],
            "sources": [
                {
                    "type": "file",
                    "path": "src/piper.cpp"
                }
            ]
        },
        {
            "name": "piper-model-darkman",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/share/piper/eo/eo-darkman-medium",
                "cp eo-darkman-medium.onnx /app/share/piper/eo/eo-darkman-medium/",
                "cp eo-darkman-medium.onnx.json /app/share/piper/eo/eo-darkman-medium/"
            ],
            "sources": [
                {
                    "type": "file",
                    "path": "models/eo/eo-darkman-medium/eo-darkman-medium.onnx"
                },
                {
                    "type": "file",
                    "path": "models/eo/eo-darkman-medium/eo-darkman-medium.onnx.json"
                }
            ]
        },
        {
            "name": "piper-model-gosia",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/share/piper/eo/eo-gosia-medium",
                "cp eo-gosia-medium.onnx /app/share/piper/eo/eo-gosia-medium/",
                "cp eo-gosia-medium.onnx.json /app/share/piper/eo/eo-gosia-medium/"
            ],
            "sources": [
                {
                    "type": "file",
                    "path": "models/eo/eo-gosia-medium/eo-gosia-medium.onnx"
                },
                {
                    "type": "file",
                    "path": "models/eo/eo-gosia-medium/eo-gosia-medium.onnx.json"
                }
            ]
        },
        {
            "name": "parolu",
            "builddir": true,
            "buildsystem": "meson",
            "build-options": {
                "env": {
                    "PYTHONPATH": "/app/lib:/app/lib/python3.12/site-packages"
                }
            },
            "sources": [
                {
                    "type": "dir",
                    "path": "."
                }
            ]
        }
    ]
}
